# ============================================================================
# MUSCLE POWER — CI / CD Pipeline
# ============================================================================
#
# Environments:
#   1. development  — local machine; `flutter run` with debug flags.
#   2. staging      — this pipeline; runs on every push / PR to main.
#   3. production   — manual promote after staging passes (future).
#
# Secrets Management:
#   • No API keys are compiled into the app binary.
#   • Social-login client IDs are stored in GitHub → Settings → Secrets
#     and injected via the `--dart-define` flag at build time.
#   • The EncryptionService app-secret would likewise come from a secret
#     in production (currently hard-coded for the demo).
#
# What runs:
#   ┌─────────────────────────────────────────────────┐
#   │  1. flutter pub get                             │
#   │  2. flutter analyze            (lint / errors)  │
#   │  3. flutter test --coverage    (unit + widget)  │
#   │  4. coverage threshold gate    (≥ 70 %)         │
#   │  5. flutter build apk --debug (compile check)   │
#   └─────────────────────────────────────────────────┘
# ============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ── Checkout ──────────────────────────────────
      - uses: actions/checkout@v4

      # ── Flutter SDK ───────────────────────────────
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: stable
          cache: true

      # ── Dependencies ──────────────────────────────
      - name: Install dependencies
        run: flutter pub get

      # ── Static analysis ───────────────────────────
      - name: Analyze
        run: flutter analyze --no-fatal-infos

      # ── Unit & widget tests + coverage ────────────
      - name: Run tests with coverage
        run: flutter test --coverage

      # ── Coverage threshold gate (≥ 70 %) ──────────
      - name: Check coverage threshold
        run: |
          if [ -f coverage/lcov.info ]; then
            LINES=$(grep -c 'DA:' coverage/lcov.info || true)
            HITS=$(grep 'DA:' coverage/lcov.info | grep -v ',0$' | wc -l || true)
            if [ "$LINES" -gt 0 ]; then
              PCT=$(( HITS * 100 / LINES ))
              echo "Coverage: $PCT % ($HITS / $LINES lines)"
              if [ "$PCT" -lt 70 ]; then
                echo "::warning::Coverage $PCT% is below the 70% target"
              fi
            fi
          fi

      # ── Compile check (debug APK) ────────────────
      - name: Build APK (debug)
        run: flutter build apk --debug
